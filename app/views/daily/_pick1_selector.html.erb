<%# locals: (subject:, date:, selected_option_id:, has_narration:) %>
<%= turbo_frame_tag dom_id(subject, "task_#{date}") do %>
  <div class="bg-white rounded-xl p-4 shadow-sm border-l-4
              <%= selected_option_id ? 'border-coral' : 'border-gray-200' %>">
    <div class="flex items-center justify-between mb-3">
      <span class="text-sm text-gray-500">Pick 1</span>
      <span class="text-lg">ðŸ“–</span>
    </div>
    <h3 class="font-medium text-gray-800 mb-3 <%= 'line-through text-gray-400' if selected_option_id %>">
      <%= subject.name %>
    </h3>

    <div class="space-y-2">
      <% subject.subject_options.each do |option| %>
        <% is_selected = selected_option_id == option.id %>
        <%= button_to toggle_completion_path(subject_id: subject.id, date: date, option_id: option.id),
            method: :post,
            class: "w-full flex items-center gap-3 p-3 rounded-lg border transition-all cursor-pointer
                   focus:outline-none focus:ring-2 focus:ring-coral focus:ring-offset-2
                   #{is_selected ? 'border-coral bg-coral/10' : 'border-gray-200 hover:border-coral/50'}",
            data: { turbo_frame: dom_id(subject, "task_#{date}") },
            aria: { label: "#{is_selected ? 'Unselect' : 'Select'}: #{option.name}" } do %>
          <span class="w-5 h-5 rounded-full border-2 flex items-center justify-center shrink-0
                      <%= is_selected ? 'border-coral' : 'border-gray-300' %>">
            <% if is_selected %>
              <span class="w-2.5 h-2.5 rounded-full bg-coral"></span>
            <% end %>
          </span>
          <span class="text-gray-700"><%= option.name %></span>
        <% end %>
      <% end %>
    </div>

    <% if subject.narration_required? %>
      <div class="mt-3 pt-3 border-t border-gray-100">
        <% if has_narration %>
          <%= link_to student_narrations_path(subject.student, date: date, subject_id: subject.id),
              class: "text-xs text-green-600 hover:text-green-700 inline-flex items-center gap-1",
              data: { turbo_frame: "_top" } do %>
            <span>âœ“</span> narrated
          <% end %>
        <% else %>
          <%= link_to new_student_narration_path(subject.student, subject_id: subject.id, date: date),
              class: "text-xs text-coral hover:text-coral/80 inline-flex items-center gap-1",
              data: { turbo_frame: "_top" } do %>
            <span>+</span> add narration
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>
