<%# locals: (subjects:, dates:, week_completions:, week_narrations:, current_date:) %>
<div class="bg-white rounded-xl shadow-sm overflow-hidden">
  <%# Header row with day labels %>
  <div class="flex items-center px-4 py-2 border-b border-gray-200 bg-gray-50">
    <div class="flex-1 min-w-0"></div>
    <div class="grid grid-cols-5 gap-1" style="width: 235px;">
      <% dates.each do |date| %>
        <% is_today = date == current_date %>
        <div class="w-11 text-center text-xs font-medium <%= is_today ? 'text-coral' : 'text-gray-500' %>">
          <%= date.strftime("%a")[0..1] %>
        </div>
      <% end %>
    </div>
  </div>

  <%# Subject rows %>
  <% subjects.each do |subject| %>
    <div class="flex items-center px-4 py-3 border-b border-gray-100 last:border-b-0">
      <div class="flex items-center gap-3 flex-1 min-w-0">
        <span class="text-lg shrink-0" aria-hidden="true">ðŸ“š</span>
        <div class="min-w-0 flex-1">
          <span class="text-sm font-medium text-gray-800 truncate block"><%= subject.name %></span>
          <% if subject.narration_required? %>
            <% if subject.has_narration_for?(current_date) %>
              <%= link_to student_narrations_path(subject.student, date: current_date, subject_id: subject.id),
                  class: "text-xs text-green-600 hover:text-green-700 inline-flex items-center gap-1",
                  data: { turbo_frame: "_top" } do %>
                <span>âœ“</span> narrated
              <% end %>
            <% else %>
              <%= link_to new_student_narration_path(subject.student, subject_id: subject.id, date: current_date),
                  class: "text-xs text-coral hover:text-coral/80 inline-flex items-center gap-1",
                  data: { turbo_frame: "_top" } do %>
                <span>+</span> narration
              <% end %>
            <% end %>
          <% end %>
        </div>
      </div>
      <div class="grid grid-cols-5 gap-1" style="width: 235px;">
        <% dates.each do |date| %>
          <% completed = week_completions.dig(subject.id)&.include?(date) || false %>
          <% has_narration = week_narrations.dig(subject.id)&.include?(date) || false %>
          <% is_today = date == current_date %>
          <%= render "today/completion_circle",
                     subject: subject,
                     date: date,
                     completed: completed,
                     has_narration: has_narration,
                     is_today: is_today %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
