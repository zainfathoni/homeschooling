<%# locals: (subjects:, dates:, week_completions:, week_pick1_options:, week_documents:, current_date:) %>
<div class="bg-white rounded-xl shadow-sm overflow-hidden">
  <%# Header row with clickable day labels %>
  <div class="flex items-center px-4 py-2 border-b border-gray-200 bg-gray-50"
       data-controller="day-selector"
       data-day-selector-selected-class="bg-coral text-white"
       data-day-selector-unselected-class="hover:bg-gray-100 text-gray-500">
    <div class="flex-1 min-w-0"></div>
    <div class="grid grid-cols-5 gap-1" style="width: 235px;">
      <% dates.each do |date| %>
        <% is_selected = date == current_date %>
        <%= link_to daily_path(date: date),
            class: "w-11 h-11 flex items-center justify-center rounded-lg text-xs font-medium
                   #{is_selected ? 'bg-coral text-white' : 'hover:bg-gray-100 text-gray-500'}",
            data: {
              turbo_frame: "daily_focus",
              day_selector_target: "day",
              action: "click->day-selector#select"
            } do %>
          <%= date.strftime("%a")[0..1] %>
        <% end %>
      <% end %>
    </div>
  </div>

  <%# Subject rows %>
  <% subjects.each do |subject| %>
    <div class="flex items-center px-4 py-3 border-b border-gray-100 last:border-b-0">
      <div class="flex items-center gap-3 flex-1 min-w-0">
        <span class="text-lg shrink-0" aria-hidden="true">ðŸ“š</span>
        <div class="min-w-0 flex-1">
          <span class="text-sm font-medium text-gray-800 truncate block"><%= subject.name %></span>
          <% if subject.narration_required? %>
            <% if subject.has_document_for?(current_date) %>
              <%= link_to student_documents_path(subject.student_for_document(current_student), date: current_date, subject_id: subject.id),
                  class: "text-xs text-green-600 hover:text-green-700 inline-flex items-center gap-1",
                  data: { turbo_frame: "_top" } do %>
                <span>âœ“</span> documented today
              <% end %>
            <% else %>
              <%= link_to new_student_document_path(subject.student_for_document(current_student), subject_id: subject.id, date: current_date),
                  class: "text-xs text-coral hover:text-coral/80 inline-flex items-center gap-1",
                  data: { turbo_frame: "_top" } do %>
                <span>+</span> add today document
              <% end %>
            <% end %>
          <% end %>
        </div>
      </div>
      <div class="grid grid-cols-5 gap-1" style="width: 235px;">
        <% dates.each do |date| %>
          <% completed = week_completions.dig(subject.id)&.include?(date) || false %>
          <% has_document = week_documents.dig(subject.id)&.include?(date) || false %>
          <% pick1_option_name = week_pick1_options[[subject.id, date]] %>
          <% is_today = date == current_date %>
          <%= render "today/completion_circle",
                     subject: subject,
                     date: date,
                     completed: completed,
                     has_document: has_document,
                     pick1_option_name: pick1_option_name,
                     is_today: is_today %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
