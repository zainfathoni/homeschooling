generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  role      Role     @default(STUDENT)
  createdAt DateTime @default(now())

  // Parent owns students; Student links to their Student record
  ownedStudents  Student[] @relation("ParentStudents")
  studentProfile Student?  @relation("StudentUser")
}

enum Role {
  PARENT
  STUDENT
}

model Student {
  id        String  @id @default(cuid())
  name      String
  avatar    String?
  yearLevel Int

  // Parent who owns this student
  parentId String
  parent   User   @relation("ParentStudents", fields: [parentId], references: [id])

  // If student has their own login
  userId String? @unique
  user   User?   @relation("StudentUser", fields: [userId], references: [id])

  subjects   StudentSubject[]
  schedules  WeeklySchedule[]
  narrations Narration[]
}

model Subject {
  id                String      @id @default(cuid())
  name              String
  icon              String?
  type              SubjectType
  scheduledDays     String? // JSON: [0,1,2,3,4] (0=Mon, 6=Sun)
  requiresNarration Boolean     @default(false)
  order             Int         @default(0)

  options    SubjectOption[]
  students   StudentSubject[]
  entries    ScheduleEntry[]
  narrations Narration[]
}

enum SubjectType {
  FIXED // Checkbox every scheduled day
  SCHEDULED // Active only on specific days
  PICK1 // Select one option per category
}

model SubjectOption {
  id        String  @id @default(cuid())
  name      String
  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
}

// Links students to their specific subjects
model StudentSubject {
  id        String  @id @default(cuid())
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([studentId, subjectId])
}

model WeeklySchedule {
  id        String   @id @default(cuid())
  weekStart DateTime // Monday of the week (ISO date)
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // Flexible school days: JSON array of day indices [0,1,2,3,4] = Mon-Fri
  schoolDays String @default("[0,1,2,3,4]")

  entries ScheduleEntry[]

  @@unique([studentId, weekStart])
}

model ScheduleEntry {
  id         String         @id @default(cuid())
  scheduleId String
  schedule   WeeklySchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  subjectId  String
  subject    Subject        @relation(fields: [subjectId], references: [id])

  // For PICK1 subjects
  selectedOptionId String?

  // Completion status for each day: JSON [false,false,true,false,false,false,false]
  completedDays String @default("[false,false,false,false,false,false,false]")

  @@unique([scheduleId, subjectId])
}

model Narration {
  id        String        @id @default(cuid())
  studentId String
  student   Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subjectId String
  subject   Subject       @relation(fields: [subjectId], references: [id])
  date      DateTime
  type      NarrationType
  content   String // Text content or file path for voice/photo
  createdAt DateTime      @default(now())
}

enum NarrationType {
  TEXT
  VOICE
  PHOTO
}
